---
title: "MRC_CSC_Sequencing_Process"
author: "MRC CSC"
date: "11/03/2015"
output: html_document
---

This report is generated as part of the Medical Research Council Clinical Sciences Centre Bioinformatics Team's illumina sequencing pipeline.

This report covers basic sequencing results including Illumina sequencing statistics, multiplexing numbers and FASTQC.


```{r,echo=F,message=T,warning=F}

split_path <- function(path) {
  if (dirname(path) %in% c(".", path)) return(basename(path))
  return(c(basename(path), split_path(dirname(path))))
}

## Read in config file.
## The config file contains paths to directories and programs.

library(raster)
library(XML)
config = data.frame(readIniFile("config.ini"))

## Now look in folders to identify Runs to be processed

basedir <- as.vector(config[config$section == "paths" & config$name == "basedir","value"])

if(dir.exists(basedir)){
  message("Searching ",basedir," for unprocessed runs ..",appendLF = T)
}else{
  stop(basedir," does not exist.\n Stopping processing")
}
subFoldersFull <- dir(file.path(basedir,""),recursive=T,include.dirs=T,full.names=T)
subFoldersFull_RelativePaths <- gsub(paste0(basedir,"\\/."),"",subFoldersFull)


## Find folders containing RTAComplete.txt, Unaligned and Unaligned/Demultiplexing.html
total_Run_folders <- length(unique(lapply(subFoldersFull_RelativePaths,function(x) split_path(x)[[length(split_path(x))]])))
Run_folders_WithRTA <- subFoldersFull_RelativePaths[grep("RTAComplete.txt",subFoldersFull_RelativePaths)]
Run_folders_WithUnaligned <- subFoldersFull_RelativePaths[grepl("Unaligned",subFoldersFull_RelativePaths)
                                                          & dir.exists(subFoldersFull)
                                                            ]
Run_folders_WithDemultiplexingComplete <- subFoldersFull_RelativePaths[grep("Demultiplexing\\.html",subFoldersFull_RelativePaths)]

RunsComplete <- dirname(Run_folders_WithRTA)
RunsComplete_Processing <- intersect(dirname(Run_folders_WithRTA),dirname(Run_folders_WithUnaligned))
RunsComplete_Processing_Demultiplexed <- intersect(RunsComplete_Processing,rev(split_path(Run_folders_WithDemultiplexingComplete))[[1]])
RunsComplete_Processing_To_Be_Demultiplexed <- setdiff(RunsComplete_Processing,RunsComplete_Processing_Demultiplexed)

knitr:::kable(data.frame(Total_Runs=total_Run_folders,
                         Total_Complete_Runs=length(RunsComplete),
           Total_Demuliplexed_Runs=length(RunsComplete_Processing_Demultiplexed),
           Total_Awaiting_Demultiplexing=length(RunsComplete_Processing_To_Be_Demultiplexed)))

foldersFull <- dir(file.path(basedir,""),recursive=F,include.dirs=T,full.names=T)
foldersFull_RelativePaths <- gsub(paste0(basedir,"\\/."),"",foldersFull)

for(i in 1:length(RunsComplete_Processing_To_Be_Demultiplexed)){
  currentRun <- foldersFull[grepl(RunsComplete_Processing_To_Be_Demultiplexed,foldersFull_RelativePaths)]
  
}
xmlFromPresentRunFolder <- xmlParse("/home/pgellert/Desktop/genomicsTestFolder/run2/runParameters.xml")
currentRunParameters <- xmlToDataFrame(xmlFromPresentRunFolder)


#xmlParse("http://forecast.weather.gov/MapClick.php?lat=29.803&lon=-82.411&FcstType=digitalDWML")

```

